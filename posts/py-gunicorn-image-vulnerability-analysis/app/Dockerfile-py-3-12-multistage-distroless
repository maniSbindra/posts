################## Stage 1: Build stage
FROM python:3.12-slim as builder

WORKDIR /app

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends gcc

# Copy only the necessary files
COPY requirements.txt /app/

RUN pip install --disable-pip-version-check -r requirements.txt --target /packages

# Copy the application code
COPY ./app.py /app
COPY ./standalone.py /app


################## Stage 2: Runtime stage
FROM mcr.microsoft.com/azurelinux/distroless/python:3.12

# Set the working directory
WORKDIR /app

# Copy only the necessary files from the builder stage
COPY --from=builder /app /app
COPY --from=builder /packages /packages

ENV FLASK_APP=app.py

# neededed only for debugging
# COPY --from=busybox /bin/sh /bin/sh
# COPY --from=busybox /bin/ls /bin/ls
# COPY --from=busybox /bin/cat /bin/cat
# COPY --from=busybox /bin/echo /bin/echo

ENV PYTHONPATH=/packages

# Expose the application port
EXPOSE 8000

CMD ["python3","/app/standalone.py"]
